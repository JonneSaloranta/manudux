name: Generate and Publish Release Notes

on:
    push:
        branches:
            - master # Automatically runs on push to master
    workflow_dispatch: # Allows manual run from GitHub UI

jobs:
    release:
        name: Generate Changelog and Release
        runs-on: ubuntu-latest

        steps:
            - name: üì• Checkout code
              uses: actions/checkout@v4

            - name: üîñ Get latest tag
              id: get_latest_tag
              run: |
                  latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
                  echo "latest_tag=$latest_tag" >> "$GITHUB_OUTPUT"

            - name: üÜï Create new tag (optional on master push)
              if: github.event_name == 'push'
              id: create_new_tag
              run: |
                  latest_tag="${{ steps.get_latest_tag.outputs.latest_tag }}"
                  version_without_v="${latest_tag#v}"

                  new_version=$(echo "$version_without_v" | awk -F. -v OFS=. '{$NF += 1 ; print}')
                  new_tag="v$new_version"

                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"
                  git tag "$new_tag"
                  git push origin "$new_tag"

                  echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: üìù Generate Changelog
              id: changelog
              uses: mikepenz/release-changelog-builder-action@v4
              with:
                  configuration: ".github/changelog-config.json"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: üöÄ Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.create_new_tag.outputs.new_tag || steps.get_latest_tag.outputs.latest_tag }}
                  name: Release ${{ steps.create_new_tag.outputs.new_tag || steps.get_latest_tag.outputs.latest_tag }}
                  body: ${{ steps.changelog.outputs.changelog }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
